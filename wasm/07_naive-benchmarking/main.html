<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Calling C Function from javascript</title>
  </head>
  <body>
    <h1>Calling C Function from javascript</h1>
    <!-- <p id="js_time" > JS</p> -->
    <p id="wasm_time" >WASM : Check Console</p>

    <script src="main.js"></script>
    <script>
      const sizeOfInt32 = 4;
      // Takes an Int32Array, copies it to the heap and returns a pointer
      function arrayToPtr(array) {
        const ptr = _malloc(array.length * sizeOfInt32); // _malloc() is a function exposed from wasm side.
        HEAP32.set(array, ptr / sizeOfInt32);
        // HEAP32 is a variable from Emscripten's memory model:
        // https://emscripten.org/docs/porting/emscripten-runtime-environment.html#emscripten-memory-model
        return ptr; // typeof ptr === 'number';
      }

      // Takes a pointer and  array length, and returns a Int32Array from the heap
      function ptrToArray(ptr, length) {
        let array = new Int32Array(length);
        const pos = ptr / sizeOfInt32;
        array.set(HEAP32.subarray(pos, pos + length));
        return array;
      }

      function quicksort(array) {
        if (array.length <= 1) {
          return array;
        }
      
        var pivot = array[0];
        
        var left = []; 
        var right = [];
      
        for (var i = 1; i < array.length; i++) {
          array[i] < pivot ? left.push(array[i]) : right.push(array[i]);
        }
      
        return quicksort(left).concat(pivot, quicksort(right));
      };

      Module['onRuntimeInitialized'] = () => {
        //  ccall(name of C function, return type, argument types, arguments);
        const SIZE = 1000000;
        let inArray = new Int32Array(SIZE);
        for (let i = 0; i < SIZE; ++i) {
            inArray[i] = Math.round(Math.random() * 2147483647);
        }
        console.log(`inArray:`, inArray);
        quickSort = cwrap('quick_sort', null, ['number', 'number', 'number']);
        let startTime = performance.now();
        let inPtr = arrayToPtr(inArray);        
        const outPtr = quickSort(inPtr, 0, inArray.length-1);        
        const outArrayWasm = ptrToArray(outPtr, inArray.length);
        console.log("Wasm quickSort takes", Math.round(performance.now() - startTime, 3), "ms");
        console.log(`outArrayWasm:`, outArrayWasm);
        
        startTime = performance.now();
        const outArrayJs = quicksort(inArray);
        console.log("quicksort takes", Math.round(performance.now() - startTime, 3), "ms");
        console.log(`outArrayJs:`, outArrayJs);

        startTime = performance.now();
        inArray.sort();
        console.log("Array.sort() takes", Math.round(performance.now() - startTime, 3), "ms");
        console.log(`inArray:`, inArray);
      }


    </script>
  </body>
</html>